# Name of your application. Used to uniquely configure containers.
service: crewcert

# Name of the container image.
image: crewcert/crewcert

# Deploy to these servers.
servers:
  web:
    - melapus.xeri.eu

# Enable SSL auto certification via Let's Encrypt and allow for multiple apps on a single web server.
# If used with Cloudflare, set encryption mode in SSL/TLS setting to "Full" to enable CF-to-app encryption.
#
# Using an SSL proxy like this requires turning on config.assume_ssl and config.force_ssl in production.rb!
proxy:
  ssl: false
  host: crewcert.xeri.eu

# Where you keep your container images (Docker Hub).
registry:
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

# Inject ENV variables into containers (secrets come from .kamal/secrets).
env:
  secret:
    - RAILS_MASTER_KEY
    - CREWCERT_DATABASE_PASSWORD
  clear:
    # GoodJob runs async inside Puma process
    GOOD_JOB_EXECUTION_MODE: async

    # Redis for caching and rate limiting
    REDIS_URL: redis://localhost:6379/1

    # Application hostname
    APP_HOST: crewcert.xeri.eu

    # Set number of cores available to the application on each server (default: 1).
    # WEB_CONCURRENCY: 2

    # Log level
    # RAILS_LOG_LEVEL: debug

# Aliases are triggered with "bin/kamal <alias>".
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

# Use a persistent storage volume for Active Storage files.
volumes:
  - "crewcert_storage:/rails/storage"

# Bridge fingerprinted assets between versions to avoid 404s on in-flight requests.
asset_path: /rails/public/assets

# Configure the image builder.
builder:
  arch: amd64

# Use accessory services (secrets come from .kamal/secrets).
# Redis is already running on the server from flatshare deployment.
# accessories:
#   redis:
#     image: valkey/valkey:8
#     host: melapus.xeri.eu
#     port: 6379
#     directories:
#       - data:/data
