name: Deploy to Production

concurrency:
  group: production
  cancel-in-progress: true

on:
  push:
    branches: [ prod ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: .ruby-version
        bundler-cache: true

    - name: Install kamal
      run: gem install kamal

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Expose GitHub Runtime for cache
      uses: crazy-max/ghaction-github-runtime@v3

    - name: Configure SSH
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Validate RAILS_MASTER_KEY
      run: |
        if [ -z "$RAILS_MASTER_KEY" ]; then
          echo "ERROR: RAILS_MASTER_KEY is empty!"
          exit 1
        fi
        echo "RAILS_MASTER_KEY length: $(echo -n "$RAILS_MASTER_KEY" | wc -c)"
        if [ $(echo -n "$RAILS_MASTER_KEY" | wc -c) -ne 32 ]; then
          echo "ERROR: RAILS_MASTER_KEY must be exactly 32 characters!"
          exit 1
        fi
        echo "RAILS_MASTER_KEY looks good!"
      env:
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}

    - name: Deploy with Kamal
      env:
        RAILS_ENV: production
        KAMAL_REGISTRY_USERNAME: ${{ secrets.KAMAL_REGISTRY_USERNAME }}
        KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
        CREWCERT_DATABASE_PASSWORD: ${{ secrets.CREWCERT_DATABASE_PASSWORD }}
      run: kamal deploy
